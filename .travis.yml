language: php

php:
  - '7.3'
  - '7.2'

dist: bionic

services:
  - mysql
  - postgresql

addons:
  postgresql: "11.2"
  hosts:
    - dev.vokuro.phalcon.io

env:
  global:
    - PHALCON_VERSION=v4.0.0-beta.2
  matrix:
    - DB=mysql DB_ADAPTER=mysql DB_PORT=3306 DB_USERNAME=root
    - DB=postgres DB_ADAPTER=pgsql DB_PORT=5432 DB_USERNAME=postgres
    - DB=sqlite DB_ADAPTER=sqlite

matrix:
  fast_finish: true

cache:
  timeout: 604800
  directories:
    - "$HOME/.composer/cache"
    - "$HOME/assets"

before_install:
  - git config --global advice.detachedHead false
  - |
      # 1. Shut down 9.* PostgreSQL database
      # 2. Install PostgreSQL 11.*
      # 3. Copy the authentication information from the old 9.6 configuration
      # 4. Create a role called "travis"
      if [ "$DB" = "postgres" ]; then
        sudo apt-get update
        sudo apt-get --yes remove postgresql\* 1> /dev/null
        sudo apt-get install -y postgresql-11 postgresql-client-11 1> /dev/null
        sudo cp /etc/postgresql/{9.6,11}/main/pg_hba.conf
        sudo service postgresql restart 11
        psql -c 'CREATE ROLE travis SUPERUSER LOGIN CREATEDB;' -U postgres
        psql --version
      fi

      # Setting up Github token
      if [ -n "$GITHUB_TOKEN" ]; then
        composer config github-oauth.github.com "$GITHUB_TOKEN"
        echo 'Add Github token'
      fi

install:
  - pecl install --force psr
  - .ci/create-db.sh
  - .ci/install-phalcon.sh

before_script:
  - travis_retry composer install --no-interaction --no-ansi --no-progress --no-suggest
  - cp tests/.env.test .env
  - vendor/bin/phinx migrate -e development
  - vendor/bin/phinx seed:run -e development
  - php -S 127.0.0.1:8888 -t public/ .htrouter.php &

script:
  - vendor/bin/codecept build --quiet
  - vendor/bin/codecept run
  - vendor/bin/psalm --show-info=false
  - |
      if [ "$TRAVIS_PHP_VERSION" = "7.2" ]; then
        phpenv config-rm xdebug.ini || true
        vendor/bin/phpcs
      fi

after_script:
  - getent hosts dev.vokuro.phalcon.io

notifications:
  email: false
